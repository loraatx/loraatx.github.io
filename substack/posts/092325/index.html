<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crash Injury Map — thispostexample</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #app { display: grid; grid-template-rows: auto auto 1fr auto; height: 100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; }
    #summary { padding: 12px 16px; border-bottom: 1px solid #eee; line-height: 1.5; }
    #summary .metrics { display: flex; flex-wrap: wrap; gap: 10px 24px; margin: 8px 0 6px; font-size: 14px; color: #222; }
    #summary .metrics b { font-weight: 600; }
    #summary p { margin: 8px 0 0; }
    #map { position: relative; }
    #map canvas { outline: none; }
    #legend { position: absolute; bottom: 16px; left: 16px; background: rgba(255,255,255,0.94); padding: 10px 12px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); font-size: 13px; }
    #legend .row { display: flex; align-items: center; margin: 4px 0; gap: 8px; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    footer { padding: 8px 16px; font-size: 12px; border-top: 1px solid #eee; color: #444; }
    .attribution a { color: inherit; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <strong>Crash Injury Map — September 23,2025</strong>
    </header>

    <!-- Summary block above the map -->
    <section id="summary">
      <div class="metrics">
        <div><b>Total crashes:</b> 48</div>
        <div><b>Total injuries:</b> 62</div>
        <div><b>Avg injuries/crash:</b> 1.29</div>
        <div><b>Severity (A/B/C/Unknown):</b> 2 / 29 / 15 / 2</div>
      </div>
      <p>
        The crashes in this dataset reflect a broad range of collision types, but certain patterns dominate.
        The most frequent is <em>angle collisions with both vehicles going straight</em> (10 cases), followed closely by
        <em>rear-end collisions in the same direction</em> (9 cases). Single-vehicle incidents also appear often,
        especially those involving a car going straight (6 cases). Complex interactions such as <em>one vehicle going
        straight while the other turns left</em> (5 cases) or <em>a vehicle stopped while another moves straight in the
        same direction</em> (5 cases) also stand out. Sideswipes in the same direction account for 4 crashes, while
        turning maneuvers (right or left) make up 5 combined cases. Less frequent but notable are opposite-direction
        crashes, whether both vehicles were going straight (2 cases) or one turned left into oncoming traffic (1 case).
        In sum, the dataset points to a concentration of angle and rear-end conflicts, but with a meaningful share of
        single-vehicle and turning-related crashes adding to the injury profile.
      </p>
    </section>

    <div id="map"></div>

    <footer>
      <span class="attribution">Basemap © OpenStreetMap contributors. Hosted via GitHub Pages. Data: uploaded CSV converted to GeoJSON.</span>
    </footer>
  </div>

  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            "tileSize": 256,
            "attribution": "© OpenStreetMap contributors"
          },
          "crashes": {
            "type": "geojson",
            "data": "./data/crashes_injury.geojson"
          }
        },
        "layers": [
          { "id": "osm", "type": "raster", "source": "osm" },
          {
            "id": "crash-points",
            "type": "circle",
            "source": "crashes",
            "paint": {
              "circle-radius": [
                "interpolate", ["linear"], ["to-number", ["get", "Crash Total Injury Count"], 1],
                0, 4, 1, 6, 3, 8, 5, 10
              ],
              "circle-color": [
                "match",
                ["get", "Crash Severity"],
                "A - SUSPECTED SERIOUS INJURY", "#c0392b",
                "B - SUSPECTED MINOR INJURY",   "#e67e22",
                "C - POSSIBLE INJURY",          "#f1c40f",
                "99 - UNKNOWN",                 "#7f8c8d",
                "#7f8c8d"
              ],
              "circle-opacity": 0.9,
              "circle-stroke-color": "#222",
              "circle-stroke-width": 0.75
            }
          }
        ]
      },
      center: [-97.7431, 30.2672],
      zoom: 10
    });

    const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true });

    map.on('click', 'crash-points', (e) => {
      const f = e.features[0];
      const p = f.properties;
      const html = `
        <div style="min-width:240px">
          <div style="font-weight:600; margin-bottom:6px;">Crash ID: ${p["Crash ID"] ?? "—"}</div>
          <div><strong>Severity:</strong> ${p["Crash Severity"] ?? "—"}</div>
          <div><strong>Total Injuries:</strong> ${p["Crash Total Injury Count"] ?? "0"}</div>
          <div><strong>Possible Injuries:</strong> ${p["Crash Possible Injury Count"] ?? "0"}</div>
          <div><strong>Manner:</strong> ${p["Manner of Collision"] ?? "—"}</div>
          <div><strong>Hour:</strong> ${p["Hour of Day"] ?? "—"}</div>
          <div><strong>AADT:</strong> ${p["Adjusted Average Daily Traffic Amount"] ?? "—"}</div>
        </div>`;
      popup.setLngLat(f.geometry.coordinates).setHTML(html).addTo(map);
    });

    map.on('mouseenter', 'crash-points', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'crash-points', () => map.getCanvas().style.cursor = '');

    function buildLegend() {
      const el = document.createElement('div');
      el.id = 'legend';
      el.innerHTML = `
        <div style="font-weight:600; margin-bottom:6px;">Legend</div>
        <div class="row"><span class="swatch" style="background:#c0392b;"></span> A — Suspected Serious Injury</div>
        <div class="row"><span class="swatch" style="background:#e67e22;"></span> B — Suspected Minor Injury</div>
        <div class="row"><span class="swatch" style="background:#f1c40f;"></span> C — Possible Injury</div>
        <div class="row"><span class="swatch" style="background:#7f8c8d;"></span> Unknown</div>
        <div style="margin-top:6px; font-size:12px; color:#555;">Point size ≈ total injury count</div>
      `;
      document.getElementById('map').appendChild(el);
    }
    map.on('load', buildLegend);
  </script>
</body>
</html>
